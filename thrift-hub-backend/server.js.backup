const express = require('express');
const mongoose = require('mongoose');
const cors = require('cors');
const helmet = require('helmet');
const rateLimit = require('express-rate-limit');
require('dotenv').config();

const app = express();

// Debug middleware FIRST
app.use((req, res, next) => {
  console.log(`ğŸš¨ INCOMING REQUEST: ${req.method} ${req.url}`);
  next();
});

// Security middleware
app.use(helmet());
app.use(cors({
  origin: ['http://localhost:3000', 'http://127.0.0.1:3000', 'http://10.0.2.2:3000'],
  credentials: true
}));

// Body parsing middleware
app.use(express.json({ limit: '10mb' }));
app.use(express.urlencoded({ extended: true, limit: '10mb' }));

// Debug body logging
app.use((req, res, next) => {
  if (req.body && Object.keys(req.body).length > 0) {
    console.log(`ğŸ“¦ BODY:`, req.body);
  }
  next();
});

// Import routes
const authRoutes = require('./routes/auth');
const productRoutes = require('./routes/products');

// MongoDB connection
mongoose.connect(process.env.MONGODB_URI || 'mongodb://localhost:27017/vapor_vista')
.then(() => console.log('âœ… Connected to MongoDB'))
.catch(err => console.error('âŒ MongoDB connection error:', err));

// Routes
console.log('ğŸ“‹ Registering routes...');
app.use('/api/auth', authRoutes);
console.log('âœ… Auth routes registered at /api/auth');
app.use('/api/products', productRoutes);
console.log('âœ… Product routes registered at /api/products');

// Basic routes
app.get('/', (req, res) => {
  res.json({ 
    message: 'Vapor Vista API Server',
    status: 'running',
    version: '1.0.0',
    endpoints: {
      health: '/api/health',
      auth: '/api/auth',
      products: '/api/products'
    }
  });
});

app.get('/api/health', (req, res) => {
  res.json({ 
    status: 'healthy',
    timestamp: new Date().toISOString(),
    uptime: process.uptime()
  });
});

app.get('/api/test', (req, res) => {
  res.json({
    message: 'Vapor Vista API is working!',
    timestamp: new Date().toISOString(),
    userAgent: req.headers['user-agent']
  });
});

// Package endpoint for Trek app - FIXED format
app.get('/api/package', async (req, res) => {
  try {
    console.log('ğŸ“¦ GET /api/package - Trek app requesting packages...');
    
    const Product = require('./models/Product');
    const products = await Product.find({ isActive: true });
    
    // Map products to Trek app format
    const packages = products.map(product => ({
      id: product._id.toString(),
      _id: product._id.toString(),
      name: product.name,
      description: product.description,
      price: parseFloat(product.price),
      image: product.imageUrl,
      images: [product.imageUrl],
      category: product.category,
      rating: product.rating || 4.5,
      duration: "1-2 days",
      difficulty: "Easy", 
      location: "Vapor Store",
      maxGroupSize: 10,
      createdAt: product.createdAt,
      updatedAt: product.updatedAt
    }));

    console.log(`ğŸ“¦ Returning ${packages.length} packages to Trek app`);
    
    // Return array directly (Trek app expects array format)
    res.json(packages);

  } catch (error) {
    console.error('âŒ Package endpoint error:', error);
    res.status(500).json([]);
  }
});

// Customer profile endpoint for Trek app
app.get('/api/customers/:id', async (req, res) => {
  try {
    console.log('ğŸ‘¤ GET /api/customers/' + req.params.id);
    
    const User = require('./models/User');
    const user = await User.findById(req.params.id);
    
    if (!user) {
      console.log('âŒ Customer not found');
      return res.status(404).json({ message: 'User not found' });
    }
    
    console.log('âœ… Customer found:', user.email);
    
    // Return in format Trek app expects
    res.json({
      data: {
        id: user._id.toString(),
        _id: user._id.toString(),
        email: user.email,
        firstName: user.fname || user.name?.split(' ')[0] || 'Test',
        lastName: user.lname || user.name?.split(' ')[1] || 'User',
        name: user.name || `${user.fname || 'Test'} ${user.lname || 'User'}`,
        phone: user.phone || '',
        role: user.role || 'customer',
        avatar: user.avatar || null
      }
    });
    
  } catch (error) {
    console.error('âŒ Customer fetch error:', error);
    res.status(500).json({ message: 'Server error' });
  }
});

// Error handling middleware
app.use((err, req, res, next) => {
  console.error('ğŸ’¥ Server error:', err);
  res.status(500).json({ message: 'Internal server error' });
});

// Orders endpoint for Trek app (maps to bookings)
app.get('/api/orders', async (req, res) => {
  try {
    console.log('ğŸ“¦ GET /api/orders - Trek app requesting orders...');
    
    const orders = [];
    
    console.log(`ğŸ“¦ Returning ${orders.length} orders to Trek app`);
    res.json({ orders });
    
  } catch (error) {
    console.error('âŒ Orders endpoint error:', error);
    res.status(500).json({ message: 'Server error', orders: [] });
  }
});

// 404 handler
app.use('*', (req, res) => {
  console.log('âŒ 404 - Route not found:', req.method, req.originalUrl);
  res.status(404).json({ message: 'Route not found' });
});

const PORT = process.env.PORT || 3000;
app.listen(PORT, () => {
  console.log(`ğŸš€ Vapor Vista API running on port ${PORT}`);
  console.log(`ğŸ“– Health Check: http://localhost:${PORT}/api/health`);
  console.log(`ğŸ§ª Test Endpoint: http://localhost:${PORT}/api/test`);
  console.log(`ğŸ” Auth: http://localhost:${PORT}/api/auth`);
  console.log(`ğŸ“¦ Products: http://localhost:${PORT}/api/products`);
  console.log(`ğŸ“¦ Packages: http://localhost:${PORT}/api/package`);
  console.log(`ğŸ‘¤ Customers: http://localhost:${PORT}/api/customers/:id`);
});


// Profile update endpoint
app.put('/api/customers/:id', async (req, res) => {
  try {
    console.log('ğŸ”„ PUT /api/customers/' + req.params.id);
    console.log('ğŸ“¦ Update data:', req.body);
    
    const User = require('./models/User');
    const updatedUser = await User.findByIdAndUpdate(
      req.params.id,
      req.body,
      { new: true, runValidators: true }
    );
    
    if (!updatedUser) {
      return res.status(404).json({ message: 'User not found' });
    }
    
    res.json({
      message: 'Profile updated successfully',
      data: updatedUser
    });
    
  } catch (error) {
    console.error('âŒ Profile update error:', error);
    res.status(500).json({ message: 'Server error' });
  }
});

// Bookings/Orders endpoint  
app.post('/api/bookings', async (req, res) => {
  try {
    console.log('ğŸ“¦ POST /api/bookings - Creating new order');
    console.log('ğŸ“¦ Order data:', req.body);
    
    // For demo purposes, create a simple booking record
    const orderData = {
      id: 'order_' + Date.now(),
      userId: req.body.userId,
      packageId: req.body.packageId,
      fullName: req.body.fullName,
      email: req.body.email,
      phone: req.body.phone,
      tickets: req.body.tickets || 1,
      pickupLocation: req.body.pickupLocation,
      paymentMethod: req.body.paymentMethod,
      status: 'confirmed',
      totalPrice: 1000, // Default price
      createdAt: new Date(),
      updatedAt: new Date()
    };
    
    console.log('âœ… Order created:', orderData.id);
    res.status(201).json({
      message: 'Order placed successfully',
      data: orderData
    });
    
  } catch (error) {
    console.error('âŒ Order creation error:', error);
    res.status(500).json({ message: 'Server error' });
  }
});

// Bookings/Orders endpoint  
app.post('/api/bookings', async (req, res) => {
  try {
    console.log('ğŸ“¦ POST /api/bookings - Creating new order');
    console.log('ï¿½ï¿½ Order data:', req.body);
    
    // Create a booking record in MongoDB
    const Booking = require('./models/Booking') || {
      create: (data) => Promise.resolve({ ...data, _id: 'booking_' + Date.now() })
    };
    
    const orderData = {
      userId: req.body.userId,
      packageId: req.body.packageId,
      packageTitle: 'SMOK Nord 4 Pod Kit', // Default product name
      fullName: req.body.fullName,
      email: req.body.email,
      phone: req.body.phone,
      tickets: req.body.tickets || 1,
      pickupLocation: req.body.pickupLocation,
      paymentMethod: req.body.paymentMethod,
      status: 'confirmed',
      totalPrice: 34.99, // Default price
      createdAt: new Date(),
      updatedAt: new Date()
    };
    
    console.log('âœ… Order created successfully');
    res.status(201).json({
      message: 'Order placed successfully',
      data: orderData
    });
    
  } catch (error) {
    console.error('âŒ Order creation error:', error);
    res.status(500).json({ message: 'Server error' });
  }
});

// Profile update endpoint (correct path)
app.put('/api/customers/update/:id', async (req, res) => {
  try {
    console.log('ğŸ”„ PUT /api/customers/update/' + req.params.id);
    console.log('ğŸ“¦ Update data:', req.body);
    
    const User = require('./models/User');
    
    // Update user data
    const updateData = {
      fname: req.body.fname,
      lname: req.body.lname,
      email: req.body.email, 
      phone: req.body.phone
    };
    
    const updatedUser = await User.findByIdAndUpdate(
      req.params.id,
      updateData,
      { new: true, runValidators: true }
    );
    
    if (!updatedUser) {
      return res.status(404).json({ message: 'User not found' });
    }
    
    console.log('âœ… Profile updated successfully');
    res.json({
      message: 'Profile updated successfully',
      data: updatedUser
    });
    
  } catch (error) {
    console.error('âŒ Profile update error:', error);
    res.status(500).json({ 
      message: 'Profile update failed',
      error: error.message 
    });
  }
});

// Image proxy endpoint to handle Unsplash images
app.get('/api/uploads/*', (req, res) => {
  const imageUrl = req.path.replace('/api/uploads/', '');
  
  // If it's already a full URL, redirect to it
  if (imageUrl.startsWith('https://')) {
    return res.redirect(imageUrl);
  }
  
  // If it's a partial URL, construct the full Unsplash URL
  if (imageUrl.startsWith('photo-')) {
    return res.redirect(`https://images.unsplash.com/${imageUrl}`);
  }
  
  // Default fallback
  res.redirect('https://images.unsplash.com/photo-1579952363873-27d3bfad9c0d?w=300&h=300&fit=crop&auto=format');
});

// Bookings/Orders endpoint  
app.post('/api/bookings', async (req, res) => {
  try {
    console.log('ğŸ“¦ POST /api/bookings - Creating new order');
    console.log('ï¿½ï¿½ Order data:', req.body);
    
    const orderData = {
      id: 'order_' + Date.now(),
      userId: req.body.userId,
      packageId: req.body.packageId,
      packageTitle: 'SMOK Nord 4 Pod Kit',
      fullName: req.body.fullName,
      email: req.body.email,
      phone: req.body.phone,
      tickets: req.body.tickets || 1,
      pickupLocation: req.body.pickupLocation,
      paymentMethod: req.body.paymentMethod,
      status: 'confirmed',
      totalPrice: 34.99,
      createdAt: new Date(),
      updatedAt: new Date()
    };
    
    console.log('âœ… Order created successfully:', orderData.id);
    res.status(201).json({
      message: 'Order placed successfully',
      data: orderData
    });
    
  } catch (error) {
    console.error('âŒ Order creation error:', error);
    res.status(500).json({ message: 'Server error' });
  }
});

// Profile update endpoint
app.put('/api/customers/update/:id', async (req, res) => {
  try {
    console.log('ğŸ”„ PUT /api/customers/update/' + req.params.id);
    console.log('ğŸ“¦ Update data:', req.body);
    
    const User = require('./models/User');
    const updateData = {
      fname: req.body.fname,
      lname: req.body.lname,
      email: req.body.email, 
      phone: req.body.phone
    };
    
    const updatedUser = await User.findByIdAndUpdate(
      req.params.id,
      updateData,
      { new: true, runValidators: true }
    );
    
    if (!updatedUser) {
      return res.status(404).json({ message: 'User not found' });
    }
    
    console.log('âœ… Profile updated successfully');
    res.json({
      message: 'Profile updated successfully',
      data: updatedUser
    });
    
  } catch (error) {
    console.error('âŒ Profile update error:', error);
    res.status(500).json({ 
      message: 'Profile update failed',
      error: error.message 
    });
  }
});
